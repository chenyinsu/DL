# IAT：一种用于图像增强与曝光校正的轻量级Transformer

## 一、 研究动机与核心问题

在真实世界中，具有挑战性的光照条件（如低光照、曝光不足和曝光过度）不仅会导致图像视觉质量下降，还会严重影响下游计算机视觉任务（如目标检测、语义分割）的性能。


传统解决方案（如低光增强、曝光校正方法）和基于深度学习的方案存在几个关键问题：
1.  **计算开销巨大**：现有的基于Transformer或MLP的先进模型（如IPT, MAXIM）参数量高达数百万甚至上亿（115.63M, 14.14M），推理速度慢，难以部署在移动设备或边缘设备上。
2.  **忽略成像物理过程**：许多方法直接在sRGB图像空间进行操作，忽略了图像信号处理器（ISP）在将RAW传感器数据转换为sRGB图像过程中所起的关键作用。ISP包含一系列复杂的、可解释的全局操作（如白平衡、颜色校正、伽马校正），这些操作对最终图像质量有决定性影响。
3.  **缺乏统一框架**：现有方法通常分别处理低光增强和曝光校正，缺乏一个统一的、轻量的框架能够同时处理多种光照挑战。

**因此，本研究的核心动机是**：提出一个**极其轻量、快速且高效**的框架，它能够**模拟并调整ISP pipeline中的关键参数**，从而自适应地处理各种具有挑战性的光照条件，同时显著提升下游高级视觉任务的性能。

## 二、 核心思想：分解与模拟ISP

受相机ISP流水线的启发，作者将图像从低质sRGB到高质量sRGB的转换过程分解为两个核心部分：
1.  **局部像素级调整（Local Pixel-wise Adjustment）**：处理与光照直接相关的局部退化，如噪声、细节丢失。这对应于ISP前端的处理。
2.  **全局ISP参数调整（Global ISP Parameter Adjustment）**：处理颜色、色调、对比度等全局属性。这对应于ISP后端的关键操作（如颜色变换矩阵、伽马校正）。

基于此，提出了**光照自适应Transformer（IAT）** 框架，其核心结构如下图所示，包含一个局部分支和一个全局分支，分别处理上述两部分：


## 三、 核心算法框架：IAT

IAT的整体目标是将一个在挑战性光照条件 $L_i$ 下捕获的sRGB图像 $I_i$，转换到一个在理想光照条件 $L_t$ 下的sRGB图像 $I_t$。其数学表达基于对ISP过程的简化建模：
$$I_t = g_t(f(I_i)) = \left(\max\left(\sum_{c_j} W_{c_i, c_j}(I_i \odot M + A), \varepsilon\right)\right)^\gamma$$
其中：
*   $f(I_i) = I_i \odot M + A$ 由**局部分支**实现，负责像素级的乘性（M）和加性（A）调整，以恢复细节和校正光照。
*   $g_t(\cdot)$ 由**全局分支**实现，负责应用一个联合颜色变换矩阵 $W$（模拟白平衡和颜色校正）和伽马校正 $\gamma$，这些是ISP的核心全局操作。

### 1. 局部分支（Local Branch）

**功能**：学习输入图像 $I_i$ 的逐像素调整映射，输出乘性图 $M$ 和加性图 $A$。
**设计理念**：为了轻量化和保持分辨率，没有采用传统的U-Net结构（涉及下采样和上采样），而是设计了一个基于Transformer思想的流式结构。

**核心模块**：**像素增强模块（PEM, Pixel-wise Enhancement Module）**
每个PEM的结构如下所示，它采用了深度wise卷积（DWConv）和点wise卷积（PWConv）的组合来极大地减少参数量和计算量，同时保持感受野：


**关键创新**：
*   **轻量化归一化（Light Normalization）**：替换了Transformer中标准的Layer Normalization。它学习缩放（a）和偏置（b）参数，并通过一个可学习的矩阵进行通道融合，该矩阵初始化为单位矩阵。
*   **层尺度（Layer Scale）**：在残差路径上引入可学习的缩放系数（k1, k2），以稳定训练并提升性能。
*   **结构**：使用3个PEM模块分别并行地处理 $M$ 和 $A$ 的生成，最后通过卷积和激活函数（ReLU for M, Tanh for A）输出。

### 2. 全局分支（Global Branch）

**功能**：预测ISP相关的全局参数，即颜色变换矩阵 $W$（3x3矩阵）和伽马值 $\gamma$。
**设计理念**：受DETR的启发，使用**可学习的查询（Query）** 来解码和预测这些参数。这些查询能够关注整个图像的全局上下文信息，从而动态地根据输入图像的内容和光照条件预测出最合适的ISP参数。

**核心模块**：**全局预测模块（GPM, Global Prediction Module）**
*   **轻量编码器**：首先使用两个卷积层对输入图像进行编码，得到低分辨率、高维的特征图，以节省计算成本并捕获全局信息。
*   **查询机制**：可学习的查询向量 $Q$ 与由编码特征生成的键（K）和值（V）进行交互。位置编码由深度wise卷积提供。
*   **参数预测**：通过前馈网络（FFN）后，输出预测的矩阵 $W$ 和伽马值 $\gamma$。**关键的是，这些参数被初始化为恒等变换（$W$ 初始化为单位矩阵，$\gamma$ 初始化为1）**，确保训练初期网络的输出与输入相近，从而稳定训练过程。


### 3. 轻量化设计总结

通过上述精巧的设计，IAT实现了极致的轻量化：
*   **参数量**：仅 **~90K**（0.09M）参数。局部分支约占20K参数，全局分支约占70K参数。
*   **计算速度**：处理一张图像仅需 **~0.004秒**。
*   **效果**：在显著减少参数和计算量的同时，性能达到了业界领先水平（SOTA）。

## 四、 工作流程与损失函数

1.  **前向传播**：
    *   输入图像 $I_i$ 同时送入局部分支和全局分支。
    *   局部分支输出 $M$ 和 $A$，计算 $I_{local} = I_i \odot M + A$。
    *   全局分支输出 $W$ 和 $\gamma$。
    *   最终输出 $I_t = (max(W \cdot I_{local}, \varepsilon))^\gamma$。

2.  **损失函数**：
    *   对于图像增强任务，使用 **平滑L1损失** 和 **基于VGG的感知损失** 的组合，以同时保证像素级的准确性和视觉感知质量。
    $$L_{total} = L_{smooth-L1}(I_t, I_{target}) + \lambda L_{VGG}(I_t, I_{target})$$
    *   对于曝光校正任务，使用 **L1损失**。
    *   此外，论文还探索了使用**RAW数据监督**（通过可逆ISP模型估计得到）来辅助训练局部分支，使其输出更接近真实的RAW数据分布，从而进一步提升性能（见论文表5）。
    $$L_{total} = L_{rgb} + \lambda \cdot L_{raw}$$

## 五、 实验验证与性能

IAT在多个低层和高层视觉任务上进行了广泛验证，均取得了优异性能。

### 1. 低光照图像增强（LOL-V1 & V2, MIT-Adobe FiveK）

在LOL和FiveK数据集上，IAT在PSNR和SSIM指标上达到了领先水平，同时参数量和推理速度远优于其他SOTA方法。


**表1：在LOL数据集上的定量结果对比**
<table>
<tr><th>Method</th><th>PSNR↑</th><th>SSIM↑</th><th>#Params (M)↓</th><th>Time (s)↓</th></tr>
<tr><td>MBLLEN[43]</td><td>17.90</td><td>0.702</td><td>20.47</td><td>1.981</td></tr>
<tr><td>UFormer[63]</td><td>16.36</td><td>0.771</td><td>5.29</td><td>0.248</td></tr>
<tr><td>MAXIM[59]</td><td>23.43</td><td>0.863</td><td>14.14</td><td>0.602</td></tr>
<tr><td><b>IAT (Ours)</b></td><td><b>23.38</b></td><td><b>0.809</b></td><td><b>0.09</b></td><td><b>0.004</b></td></tr>
</table>


### 2. 曝光校正

在曝光校正数据集上，IAT同样取得了最佳的综合性能（PSNR, SSIM, PI），并且速度最快。


**表3：曝光校正结果对比（平均）**
<table>
<tr><th>Method</th><th>PSNR↑</th><th>SSIM↑</th><th>PI↓</th><th>#Params (M)↓</th></tr>
<tr><td>MSEC[2]</td><td>19.48</td><td>0.739</td><td>2.251</td><td>7.0</td></tr>
<tr><td><b>IAT (Ours)</b></td><td><b>20.34</b></td><td><b>0.844</b></td><td><b>2.249</b></td><td><b>0.09</b></td></tr>
</table>

### 3. 高层视觉任务（目标检测与语义分割）

将IAT作为预处理模块，可以显著提升在低光照数据集（如EXDark）上的目标检测（mAP）和语义分割（mIOU）性能，且引入的延迟极低。


**表4：高层任务性能提升**
<table>
<tr><th>Task</th><th>Dataset</th><th>Baseline</th><th>+IAT</th><th>Delta (↑)</th></tr>
<tr><td>Object Detection</td><td>EXDark</td><td>76.4 mAP</td><td>77.2 mAP</td><td>+0.8</td></tr>
<tr><td>Semantic Segmentation</td><td>ACDC</td><td>63.3 mIOU</td><td>63.8 mIOU</td><td>+0.5</td></tr>
</table>

## 六、 总结

Illumination Adaptive Transformer (IAT) 的核心贡献在于：

1.  **创新性架构**：将图像增强问题分解为**局部像素调整**和**全局ISP参数预测**两个子问题，并分别用轻量化的局部分支和全局分支解决。
2.  **极致轻量化**：通过使用**深度wise卷积**、**定制化的轻量归一化**和**参数化查询机制**，在仅使用 **~90K参数** 和 **~4ms推理时间** 的情况下，达到了与大型SOTA模型相当甚至更优的性能。
3.  **物理可解释性**：全局分支预测的参数（颜色矩阵、伽马值）具有明确的物理意义，与相机ISP流程相对应，使得模型决策过程更加透明。
4.  **广泛适用性**：在多个低层（增强、校正）和高层（检测、分割）视觉任务上均验证了其有效性，展示了其作为通用光照自适应预处理模块的潜力。

这项工作为在资源受限的设备上实现高性能的实时图像增强和计算摄影应用提供了强有力的解决方案。
